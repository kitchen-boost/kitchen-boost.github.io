<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi PWA Vue CDN — con Router</title>

    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Mi Vue PWA">

    <!-- Bulma CSS (se mantiene) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <!-- Font Awesome: iconos representativos (CDN) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <div id="app">
        <nav class="navbar is-primary" role="navigation" aria-label="main navigation">
            <div class="navbar-brand">
                <a class="navbar-item" href="#" @click.prevent>
                    <span class="icon" aria-hidden="true"><i class="fa-solid fa-utensils"></i></span>
                    <strong style="margin-left:8px">Kitchen Boost</strong>
                </a>

                <!-- burger usa store.mobileMenu -->
                <a role="button"
                   class="navbar-burger"
                   :class="{ 'is-active': store.mobileMenu }"
                   @click="store.mobileMenu = !store.mobileMenu"
                   aria-label="menu"
                   aria-expanded="false">
                    <span aria-hidden="true"></span>
                    <span aria-hidden="true"></span>
                    <span aria-hidden="true"></span>
                </a>
            </div>

            <!-- navbar-menu también atado al store -->
            <div class="navbar-menu" :class="{ 'is-active': store.mobileMenu }">
                <div class="navbar-start">
                    <router-link class="navbar-item" to="/" @click.native="store.mobileMenu = false">
                        <span class="icon"><i class="fa-solid fa-house"></i></span>
                        <span style="margin-left:8px">Inicio</span>
                    </router-link>
                    <router-link class="navbar-item" to="/almacenes" @click.native="store.mobileMenu = false">
                        <span class="icon"><i class="fa-solid fa-warehouse"></i></span>
                        <span style="margin-left:8px">Almacenes</span>
                    </router-link>
                    <router-link class="navbar-item" to="/productos" @click.native="store.mobileMenu = false">
                        <span class="icon"><i class="fa-solid fa-box-open"></i></span>
                        <span style="margin-left:8px">Productos</span>
                    </router-link>
                    <router-link class="navbar-item" to="/ventas" @click.native="store.mobileMenu = false">
                        <span class="icon"><i class="fa-solid fa-receipt"></i></span>
                        <span style="margin-left:8px">Ventas</span>
                    </router-link>

                    <!-- Nuevo: enlace a Recetas -->
                    <router-link class="navbar-item" to="/recetas" @click.native="store.mobileMenu = false">
                        <span class="icon"><i class="fa-solid fa-bowl-food"></i></span>
                        <span style="margin-left:8px">Recetas</span>
                    </router-link>
                </div>
            </div>
        </nav>

        <section class="section">
            <div class="container">
                <router-view />
            </div>
        </section>
    </div>

    <!-- Vue + Vue Router (CDN) -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/vue-router@4/dist/vue-router.global.js"></script>

    <script>
    (function () {
        const { createApp, ref, reactive, provide, computed, watch } = Vue;
        const { createRouter, createWebHashHistory } = VueRouter;

        // Simple global "store" para compartir datos entre rutas
        const store = reactive({
            offline: !navigator.onLine,
            mobileMenu: false,
            // id de receta que se debe abrir desde otra vista (p.ej. Products)
            openRecipeId: null,
            // ejemplo de datos compartidos: recetas/productos/almacenes
            almacenes: [
                { id: 1, nombre: 'Principal', ubicacion: 'Centro' }
            ],
            productos: [
                { id: 1, nombre: 'Tomate', tipo: 'basico', almacenId: 1, almacen: 'Principal', unidad: 'Kilogramos', stock: 50, precio: 0, ingredientes: [] }
            ],
            ventas: [],
            // nuevo: recetas (se almacenan también, y al crear una receta se puede crear un producto compuesto)
            recetas: []
        });

        // Claves de localStorage y helpers globales para persistencia / sincronización
        const PRODUCTOS_KEY = 'kb_productos';
        const RECETAS_KEY = 'kb_recetas';

        const saveProductosToStorage = () => {
            try { localStorage.setItem(PRODUCTOS_KEY, JSON.stringify(store.productos)); } catch (e) { console.error('saveProductosToStorage', e); }
        };
        const saveRecetasToStorage = () => {
            try { localStorage.setItem(RECETAS_KEY, JSON.stringify(store.recetas)); } catch (e) { console.error('saveRecetasToStorage', e); }
        };

        // Cargar desde storage al iniciar (si existe)
        try {
            const rawP = localStorage.getItem(PRODUCTOS_KEY);
            if (rawP) {
                const parsedP = JSON.parse(rawP);
                if (Array.isArray(parsedP)) store.productos = parsedP;
            }
            const rawR = localStorage.getItem(RECETAS_KEY);
            if (rawR) {
                const parsedR = JSON.parse(rawR);
                if (Array.isArray(parsedR)) store.recetas = parsedR;
            }
        } catch (e) { /* ignore */ }

        // Recalcula precios de recetas y productos compuestos en base a precios actuales de ingredientes
        const updateCompoundProductPrices = () => {
            store.recetas.forEach(receta => {
                let total = 0;
                receta.ingredientes.forEach(ing => {
                    const prod = store.productos.find(p => p.id === ing.productoId);
                    if (prod) total += Number(prod.precio || 0) * Number(ing.cantidad || 0);
                });
                // sumar gastos si existen
                if (Array.isArray(receta.gastos)) {
                    receta.gastos.forEach(g => { total += Number(g.costo || 0); });
                }
                receta.precio = Number(total) || 0;

                const prodIdx = store.productos.findIndex(p => p.nombre === receta.nombre && p.tipo === 'compuesto');
                if (prodIdx !== -1) {
                    store.productos[prodIdx].precio = receta.precio;
                }
            });
            saveRecetasToStorage();
            saveProductosToStorage();
        };

        // Vigilar cambios en los precios de los productos básicos y recalcular recetas
        watch(() => store.productos.map(p => Number(p.precio || 0)), (/* newVal, oldVal */) => {
            updateCompoundProductPrices();
        }, { deep: false });

        // Home (counter + estado offline)
        const Home = {
            name: 'HomeView',
            template: `
                <div>
                    <h1 class="title">Inicio</h1>
                    <p class="subtitle">Contador simple y estado offline</p>

                    <div class="box">
                        <p class="has-text-weight-semibold">Contador: {{ contador }}</p>
                        <button class="button is-primary" @click="incrementar">Incrementar</button>
                        <p v-if="store.offline" class="notification is-warning mt-3">¡Estás sin conexión!</p>
                    </div>
                </div>
            `,
            setup() {
                const contador = ref(0);
                const incrementar = () => contador.value++;
                return { contador, incrementar, store };
            }
        };

        // Almacenes view
        const Almacenes = {
            name: 'AlmacenesView',
            template: `
                <div>
                    <h1 class="title">Almacenes</h1>
                    <p class="subtitle">Gestiona tus almacenes</p>

                    <div class="box">
                        <div class="table-container">
                            <table class="table is-fullwidth is-striped is-hoverable">
                                <thead>
                                    <tr><th>Nombre</th><th>Ubicación</th></tr>
                                </thead>
                                <tbody>
                                    <tr v-for="a in store.almacenes" :key="a.id">
                                        <td><strong>{{ a.nombre }}</strong></td>
                                        <td>{{ a.ubicacion }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `,
            setup() { return { store }; }
        };

        // Productos view (modificado: modal separada para formulario)
        const Productos = {
            name: 'ProductosView',
            template: `
                <div>
                    <h1 class="title">Productos</h1>
                    <p class="subtitle">Listado de productos — crear / eliminar</p>

                    <div class="mb-4">
                        <button class="button is-primary" @click="openModal">
                            <span class="icon"><i class="fa-solid fa-plus"></i></span>
                            <span>Nuevo producto</span>
                        </button>
                    </div>

                    <!-- Modal para agregar/editar producto -->
                    <div class="modal" :class="{ 'is-active': showModal }">
                        <div class="modal-background" @click="closeModal"></div>
                        <div class="modal-card">
                            <header class="modal-card-head">
                                <p class="modal-card-title">
                                    <span class="icon"><i class="fa-solid fa-plus"></i></span>
                                    <span>{{ editingId ? 'Editar producto' : 'Agregar nuevo producto' }}</span>
                                </p>
                                <button class="delete" @click="closeModal"></button>
                            </header>
                            <section class="modal-card-body">
                                <form @submit.prevent="addProduct">
                                    <div class="field">
                                        <label class="label">Nombre</label>
                                        <div class="control">
                                            <input class="input" v-model="newProduct.nombre" placeholder="Ej. Tomate" required>
                                        </div>
                                    </div>

                                    <div class="columns is-mobile">
                                        <div class="column is-6">
                                            <div class="field">
                                                <label class="label">Tipo</label>
                                                <div class="control">
                                                    <div class="select is-fullwidth">
                                                        <select v-model="newProduct.tipo">
                                                            <option value="basico">Básico</option>
                                                            <option value="compuesto">Compuesto</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="column is-6">
                                            <div class="field">
                                                <label class="label">Almacén</label>
                                                <div class="control">
                                                    <div class="select is-fullwidth">
                                                        <select v-model.number="newProduct.almacenId" required>
                                                            <option v-for="a in store.almacenes" :key="a.id" :value="a.id">{{ a.nombre }}</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="columns is-mobile">
                                        <div class="column is-6">
                                            <div class="field">
                                                <label class="label">Unidad</label>
                                                <div class="control">
                                                    <div class="select is-fullwidth">
                                                        <select v-model="newProduct.unidad" required>
                                                            <option value="Unidad">Unidad</option>
                                                            <option value="Gramos">Gramos</option>
                                                            <option value="Kilogramos">Kilogramos</option>
                                                            <option value="Litros">Litros</option>
                                                            <option value="Mililitros">Mililitros</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="column is-6">
                                            <div class="field">
                                                <label class="label">Stock</label>
                                                <div class="control">
                                                    <input type="number" class="input" v-model.number="newProduct.stock" min="0" required>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="field">
                                        <label class="label">Precio</label>
                                        <div class="control">
                                            <input type="number" class="input" v-model.number="newProduct.precio" step="0.01" min="0">
                                        </div>
                                    </div>

                                    <div class="field is-grouped">
                                        <div class="control">
                                            <button type="submit" class="button is-primary">
                                                <span class="icon"><i class="fa-solid fa-check"></i></span>
                                                <span>{{ editingId ? 'Actualizar' : 'Guardar' }}</span>
                                            </button>
                                        </div>
                                        <div class="control">
                                            <button type="button" @click="closeModal" class="button is-light">Cancelar</button>
                                        </div>
                                    </div>
                                </form>
                            </section>
                        </div>
                    </div>

                    <!-- Vista de tarjetas en móviles (is-hidden-tablet) -->
                    <div class="is-hidden-tablet">
                        <div class="columns is-multiline is-mobile">
                            <div class="column is-12" v-for="p in store.productos" :key="p.id">
                                <div class="card">
                                    <div class="card-content">
                                        <div class="media">
                                            <div class="media-content">
                                                <p class="title is-5">
                                                    {{ p.nombre }}
                                                    <span v-if="p.tipo === 'compuesto'" class="tag is-info is-light" style="margin-left:8px">Receta</span>
                                                </p>
                                             <p class="subtitle is-6">{{ p.almacen }}</p>
                                         </div>
                                        </div>
                                        <div class="content">
                                            <div class="level is-mobile mb-2">
                                                <div class="level-left">
                                                    <div class="level-item">
                                                        <div>
                                                            <span class="tag is-light" :class="p.tipo === 'basico' ? 'is-info' : 'is-warning'">
                                                                {{ p.tipo }}
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="level-right">
                                                    <div class="level-item">
                                                        <strong class="has-text-success">\${{ p.precio.toFixed(2) }}</strong>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="level is-mobile mb-2">
                                                <div class="level-left">
                                                    <div class="level-item">
                                                        <small class="has-text-grey">{{ p.unidad }}</small>
                                                    </div>
                                                </div>
                                                <div class="level-right">
                                                    <div class="level-item">
                                                        <span class="tag" :class="p.stock > 20 ? 'is-success' : p.stock > 0 ? 'is-warning' : 'is-danger'">
                                                            Stock: {{ p.stock }}
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <footer class="card-footer">
                                        <a v-if="p.tipo !== 'compuesto'" href="#" class="card-footer-item has-text-info" @click.prevent="editProduct(p.id)">
                                            <span class="icon"><i class="fa-solid fa-pen"></i></span>
                                            <span>Editar</span>
                                        </a>
                                        <a href="#" class="card-footer-item has-text-danger" @click.prevent="deleteProduct(p.id)">
                                            <span class="icon"><i class="fa-solid fa-trash"></i></span>
                                            <span>Eliminar</span>
                                        </a>
                                    </footer>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Vista de tabla en tablets y escritorio (is-hidden-mobile) -->
                    <div class="is-hidden-mobile">
                        <div class="box">
                            <div class="table-container">
                                <table class="table is-fullwidth is-striped">
                                    <thead>
                                        <tr>
                                            <th>Nombre</th>
                                            <th>Tipo</th>
                                            <th>Almacén</th>
                                            <th>Unidad</th>
                                            <th>Stock</th>
                                            <th>Precio</th>
                                            <th style="width:120px">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="p in store.productos" :key="p.id">
                                            <td>{{ p.nombre }}</td>
                                            <td>
                                                <span class="tag" :class="p.tipo === 'basico' ? 'is-info' : 'is-warning'">
                                                    {{ p.tipo }}
                                                </span>
                                            </td>
                                            <td>{{ p.almacen || (getAlmacenName(p.almacenId) || '-') }}</td>
                                            <td>{{ p.unidad || 'Unidad' }}</td>
                                            <td>
                                                <span class="tag" :class="p.stock > 20 ? 'is-success' : p.stock > 0 ? 'is-warning' : 'is-danger'">
                                                    {{ p.stock }}
                                                </span>
                                            </td>
                                            <td>\${{ p.precio.toFixed(2) }}</td>
                                            <td>
                                                <button class="button is-small is-info is-outlined mr-2" @click="editProduct(p.id)">
                                                    <span class="icon"><i class="fa-solid fa-pen"></i></span>
                                                </button>
                                                <button class="button is-small is-danger is-outlined" @click="deleteProduct(p.id)">
                                                    <span class="icon"><i class="fa-solid fa-trash"></i></span>
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `,
            setup() {
                const showModal = ref(false);
                const editingId = ref(null);
                
                // Template vacío para reiniciar el formulario
                const getEmptyProduct = () => ({
                    nombre: '',
                    tipo: 'basico',
                    almacenId: (store.almacenes[0] && store.almacenes[0].id) || null,
                    almacen: '',
                    unidad: 'Unidad',
                    stock: 0,
                    precio: 0,
                    ingredientes: []
                });
                
                const newProduct = ref(getEmptyProduct());

                const STORAGE_KEY = 'kb_productos';

                const saveProductos = () => {
                    try {
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(store.productos));
                    } catch (e) { console.error('Error guardando productos:', e); }
                };

                // Abre la modal y reinicia el formulario
                const openModal = () => {
                    editingId.value = null;
                    newProduct.value = getEmptyProduct();
                    showModal.value = true;
                };

                // Cierra la modal y vacía el formulario
                const closeModal = () => {
                    showModal.value = false;
                    editingId.value = null;
                    newProduct.value = getEmptyProduct();
                };

                // Abre modal para editar
                const editProduct = (id) => {
                    const producto = store.productos.find(p => p.id === id);
                    if (!producto) return;

                    // Si es un producto compuesto (generado por una receta),
                    // abrimos el editor de receta en su lugar.
                    if (producto.tipo === 'compuesto') {
                        // buscar receta por nombre (coincidencia creada al guardar receta)
                        const rec = store.recetas.find(r => r.nombre === producto.nombre);
                        if (rec) {
                            store.openRecipeId = rec.id;
                            // navegar a la ruta de recetas (hash router)
                            location.hash = '#/recetas';
                            return;
                        }
                    }

                    // comportamiento por defecto: editar como producto
                    editingId.value = id;
                    newProduct.value = { ...producto };
                    showModal.value = true;
                };

                // Añade o actualiza un producto
                const addProduct = () => {
                    if (!newProduct.value.nombre.trim()) {
                        alert('Nombre requerido');
                        return;
                    }
                    if (!newProduct.value.unidad) {
                        alert('Seleccione la unidad de medida');
                        return;
                    }

                    if (editingId.value) {
                        // Actualizar producto existente
                        const idx = store.productos.findIndex(p => p.id === editingId.value);
                        if (idx !== -1) {
                            const almacenObj = store.almacenes.find(a => a.id == newProduct.value.almacenId);
                            store.productos[idx] = {
                                ...store.productos[idx],
                                nombre: newProduct.value.nombre.trim(),
                                tipo: newProduct.value.tipo,
                                almacenId: newProduct.value.almacenId,
                                almacen: almacenObj ? almacenObj.nombre : '',
                                unidad: newProduct.value.unidad,
                                precio: Number(newProduct.value.precio) || 0,
                                stock: Number(newProduct.value.stock) || 0
                            };
                            // Sincronizar precios de recetas si cambió el precio
                            updateCompoundProductPrices();
                         }
                    } else {
                        // Crear nuevo producto
                        const nextId = store.productos.length ? Math.max(...store.productos.map(p => p.id)) + 1 : 1;
                        const almacenObj = store.almacenes.find(a => a.id == newProduct.value.almacenId);
                        const producto = {
                            id: nextId,
                            nombre: newProduct.value.nombre.trim(),
                            tipo: newProduct.value.tipo,
                            almacenId: newProduct.value.almacenId,
                            almacen: almacenObj ? almacenObj.nombre : '',
                            unidad: newProduct.value.unidad,
                            precio: Number(newProduct.value.precio) || 0,
                            stock: Number(newProduct.value.stock) || 0,
                            ingredientes: newProduct.value.ingredientes || []
                        };
                        store.productos.push(producto);
                    }
                    saveProductos();
                    closeModal();
                };

                const deleteProduct = (id) => {
                    if (!confirm('¿Eliminar producto?')) return;
                    store.productos = store.productos.filter(p => p.id !== id);
                    saveProductos();
                };

                // Actualizar precios de productos compuestos cuando cambia un ingrediente
                const updateCompoundProductPrices = () => {
                    store.recetas.forEach(receta => {
                        let totalPrecio = 0;
                        receta.ingredientes.forEach(ing => {
                            const prod = store.productos.find(p => p.id === ing.productoId);
                            if (prod) {
                                totalPrecio += prod.precio * ing.cantidad;
                            }
                        });
                        
                        // Actualizar receta
                        receta.precio = totalPrecio;
                        
                        // Actualizar producto compuesto asociado
                        const prodIdx = store.productos.findIndex(p => p.nombre === receta.nombre && p.tipo === 'compuesto');
                        if (prodIdx !== -1) {
                            store.productos[prodIdx].precio = totalPrecio;
                        }
                    });
                    saveProductos();
                    saveRecetasStorage();
                };

                const getAlmacenName = (id) => {
                    const a = store.almacenes.find(x => x.id == id);
                    return a ? a.nombre : '';
                };

                return { store, showModal, editingId, newProduct, openModal, closeModal, editProduct, addProduct, deleteProduct, updateCompoundProductPrices, getAlmacenName };
            }
        };

        // Nuevo: Recetas view
        const Recetas = {
            name: 'RecetasView',
            template: `
                <div>
                    <h1 class="title">Recetas</h1>
                    <p class="subtitle">Crear recetas que generen productos compuestos</p>

                    <div class="mb-4">
                        <button class="button is-primary" @click="openModal">
                            <span class="icon"><i class="fa-solid fa-plus"></i></span>
                            <span>Nueva receta</span>
                        </button>
                    </div>

                    <!-- Modal receta -->
                    <div class="modal" :class="{ 'is-active': showModal }">
                        <div class="modal-background" @click="closeModal"></div>
                        <div class="modal-card" style="width:900px; max-width:95%;">
                            <header class="modal-card-head">
                                <p class="modal-card-title">
                                    <span class="icon"><i class="fa-solid fa-book-open"></i></span>
                                    <span>{{ editingId ? 'Editar receta' : 'Crear receta' }}</span>
                                </p>
                                <button class="delete" @click="closeModal"></button>
                            </header>
                            <section class="modal-card-body">
                                <form @submit.prevent="saveRecipe">
                                    <div class="field">
                                        <label class="label">Nombre de la receta / producto</label>
                                        <div class="control">
                                            <input class="input" v-model="recipe.nombre" placeholder="Ej. Salsa de Tomate" required>
                                        </div>
                                    </div>

                                    <div class="columns">
                                        <div class="column is-6">
                                            <div class="field">
                                                <label class="label">Almacén destino</label>
                                                <div class="control">
                                                    <div class="select is-fullwidth">
                                                        <select v-model.number="recipe.almacenId" required>
                                                            <option v-for="a in store.almacenes" :key="a.id" :value="a.id">{{ a.nombre }}</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="column is-6">
                                            <div class="field">
                                                <label class="label">Unidad de medida</label>
                                                <div class="control">
                                                    <div class="select is-fullwidth">
                                                        <select v-model="recipe.unidad" required>
                                                            <option>Unidad</option>
                                                            <option>Gramos</option>
                                                            <option>Kilogramos</option>
                                                            <option>Litros</option>
                                                            <option>Mililitros</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <h3 class="subtitle is-6">Ingredientes</h3>
                                    <div v-for="(ing, idx) in recipe.ingredientes" :key="idx" class="box">
                                        <div class="columns is-vcentered">
                                            <div class="column is-5">
                                                <div class="field">
                                                    <label class="label is-small">Producto</label>
                                                    <div class="control">
                                                        <div class="select is-fullwidth">
                                                            <select v-model.number="ing.productoId" required>
                                                                <option :value="null">-- seleccionar --</option>
                                                                <option v-for="p in store.productos" :key="p.id" :value="p.id">{{ p.nombre }} — {{ p.almacen }}</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="column is-2">
                                                <div class="field">
                                                    <label class="label is-small">Cantidad</label>
                                                    <div class="control">
                                                        <input type="number" class="input" v-model.number="ing.cantidad" min="0.01" step="0.01" required>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="column is-3">
                                                <div class="field">
                                                    <label class="label is-small">Unidad de medida</label>
                                                    <div class="control">
                                                        <div class="select is-fullwidth">
                                                            <select v-model="ing.unidad" required>
                                                                <option value="">-- Seleccionar --</option>
                                                                <option value="Unidad">Unidad</option>
                                                                <option value="Gramos">Gramos</option>
                                                                <option value="Kilogramos">Kilogramos</option>
                                                                <option value="Litros">Litros</option>
                                                                <option value="Mililitros">Mililitros</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="column is-1">
                                                <button class="button is-danger is-light" type="button" @click="removeIngredient(idx)">
                                                    <span class="icon"><i class="fa-solid fa-trash"></i></span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="field">
                                        <button type="button" class="button is-link is-light" @click="addIngredient">
                                            <span class="icon"><i class="fa-solid fa-plus"></i></span>
                                            <span>Agregar ingrediente</span>
                                        </button>
                                    </div>

                                    <hr>
                                    <h3 class="subtitle is-6">Gastos Adicionales</h3>
                                    <div v-for="(gasto, idx) in recipe.gastos" :key="idx" class="box">
                                        <div class="columns is-vcentered">
                                            <div class="column is-8">
                                                <div class="field">
                                                    <label class="label is-small">Concepto</label>
                                                    <div class="control">
                                                        <input class="input" v-model="gasto.concepto" placeholder="Ej. Mano de obra, Embalaje" required>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="column is-3">
                                                <div class="field">
                                                    <label class="label is-small">Costo</label>
                                                    <div class="control">
                                                        <input type="number" class="input" v-model.number="gasto.costo" min="0" step="0.01" required>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="column is-1">
                                                <button class="button is-danger is-light" type="button" @click="removeGasto(idx)">
                                                    <span class="icon"><i class="fa-solid fa-trash"></i></span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="field">
                                        <button type="button" class="button is-link is-light" @click="addGasto">
                                            <span class="icon"><i class="fa-solid fa-plus"></i></span>
                                            <span>Agregar gasto</span>
                                        </button>
                                    </div>

                                    <hr>
                                    <div class="box has-background-light">
                                        <div class="level">
                                            <div class="level-left">
                                                <div class="level-item">
                                                    <span><strong>Costo de ingredientes:</strong></span>
                                                </div>
                                            </div>
                                            <div class="level-right">
                                                <div class="level-item">
                                                    <span class="has-text-info"><strong>\${{ costIngredientes.toFixed(2) }}</strong></span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="level">
                                            <div class="level-left">
                                                <div class="level-item">
                                                    <span><strong>Gastos adicionales:</strong></span>
                                                </div>
                                            </div>
                                            <div class="level-right">
                                                <div class="level-item">
                                                    <span class="has-text-warning"><strong>\${{ costGastos.toFixed(2) }}</strong></span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="level">
                                            <div class="level-left">
                                                <div class="level-item">
                                                    <span><strong>Precio total (calculado):</strong></span>
                                                </div>
                                            </div>
                                            <div class="level-right">
                                                <div class="level-item">
                                                    <span class="has-text-success"><strong>\${{ calculatedPrice.toFixed(2) }}</strong></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="field is-grouped">
                                        <div class="control">
                                            <button type="submit" class="button is-primary">{{ editingId ? 'Actualizar receta' : 'Guardar receta y crear producto' }}</button>
                                        </div>
                                        <div class="control">
                                            <button type="button" class="button is-light" @click="closeModal">Cancelar</button>
                                        </div>
                                    </div>
                                </form>
                            </section>
                        </div>
                    </div>

                    <!-- Lista de recetas -->
                    <div class="box" v-if="store.recetas.length">
                        <div class="is-hidden-mobile">
                            <table class="table is-fullwidth is-striped">
                                <thead>
                                    <tr><th>Nombre</th><th>Almacén</th><th>Ingredientes</th><th>Precio</th><th>Acciones</th></tr>
                                </thead>
                                <tbody>
                                    <tr v-for="r in store.recetas" :key="r.id">
                                        <td>{{ r.nombre }}</td>
                                        <td>{{ r.almacen }}</td>
                                        <td>
                                            <ul style="margin: 0; padding-left: 20px;">
                                                <li v-for="ing in r.ingredientes" :key="ing.productoId">{{ ing.cantidad }} {{ ing.unidad }} — {{ ing.nombre }}</li>
                                            </ul>
                                        </td>
                                        <td>\${{ r.precio.toFixed(2) }}</td>
                                        <td>
                                            <button class="button is-small is-info is-outlined mr-2" @click="editRecipe(r.id)">
                                                <span class="icon"><i class="fa-solid fa-pen"></i></span>
                                            </button>
                                            <button class="button is-small is-danger is-outlined" @click="deleteRecipe(r.id)">
                                                <span class="icon"><i class="fa-solid fa-trash"></i></span>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="is-hidden-tablet">
                            <div class="columns is-multiline is-mobile">
                                <div class="column is-12" v-for="r in store.recetas" :key="r.id">
                                    <div class="card">
                                        <div class="card-content">
                                            <p class="title is-5">{{ r.nombre }}</p>
                                            <p class="subtitle is-6">{{ r.almacen }}</p>
                                            <div class="content">
                                                <p><strong>Ingredientes:</strong></p>
                                                <ul style="margin: 0; padding-left: 20px;">
                                                    <li v-for="ing in r.ingredientes" :key="ing.productoId">{{ ing.cantidad }} {{ ing.unidad }} — {{ ing.nombre }}</li>
                                                </ul>
                                                <p class="mt-3"><strong>Precio: </strong>\${{ r.precio.toFixed(2) }}</p>
                                            </div>
                                        </div>
                                        <footer class="card-footer">
                                            <a href="#" class="card-footer-item has-text-info" @click.prevent="editRecipe(r.id)">
                                                <span class="icon"><i class="fa-solid fa-pen"></i></span>
                                                <span>Editar</span>
                                            </a>
                                            <a href="#" class="card-footer-item has-text-danger" @click.prevent="deleteRecipe(r.id)">
                                                <span class="icon"><i class="fa-solid fa-trash"></i></span>
                                                <span>Eliminar</span>
                                            </a>
                                        </footer>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div v-else class="notification is-info">No hay recetas creadas.</div>
                </div>
            `,
            setup() {
                const showModal = ref(false);
                const editingId = ref(null);
                const recipe = ref({
                    nombre: '',
                    almacenId: (store.almacenes[0] && store.almacenes[0].id) || null,
                    unidad: 'Unidad',
                    ingredientes: [],
                    gastos: []
                });

                const RECETAS_KEY = 'kb_recetas';
                const PRODUCTOS_KEY = 'kb_productos';

                const getEmptyRecipe = () => ({
                    nombre: '',
                    almacenId: (store.almacenes[0] && store.almacenes[0].id) || null,
                    unidad: 'Unidad',
                    ingredientes: [],
                    gastos: []
                });

                const openModal = () => {
                    editingId.value = null;
                    recipe.value = getEmptyRecipe();
                    addIngredient();
                    showModal.value = true;
                };
                const closeModal = () => { 
                    showModal.value = false;
                    editingId.value = null;
                };

                const editRecipe = (id) => {
                    const rec = store.recetas.find(r => r.id === id);
                    if (rec) {
                        editingId.value = id;
                        recipe.value = JSON.parse(JSON.stringify(rec));
                        showModal.value = true;
                    }
                };

                // Cuando otra vista solicita abrir el editor de receta
                watch(() => store.openRecipeId, (val) => {
                    if (val) {
                        // abrir modal de receta para ese id y limpiar la bandera
                        editRecipe(val);
                        store.openRecipeId = null;
                        location.hash = '#/recetas';
                    }
                });

                const addIngredient = () => {
                    recipe.value.ingredientes.push({ productoId: null, cantidad: 1, unidad: '' });
                };
                const removeIngredient = (i) => {
                    recipe.value.ingredientes.splice(i, 1);
                };

                const addGasto = () => {
                    recipe.value.gastos.push({ concepto: '', costo: 0 });
                };
                const removeGasto = (i) => {
                    recipe.value.gastos.splice(i, 1);
                };

                // Costo de ingredientes
                const costIngredientes = computed(() => {
                    return recipe.value.ingredientes.reduce((sum, ing) => {
                        const p = store.productos.find(x => x.id == ing.productoId);
                        const precioUnit = p ? Number(p.precio) : 0;
                        return sum + (precioUnit * Number(ing.cantidad || 0));
                    }, 0);
                });

                // Costo de gastos adicionales
                const costGastos = computed(() => {
                    return recipe.value.gastos.reduce((sum, gasto) => {
                        return sum + (Number(gasto.costo) || 0);
                    }, 0);
                });

                // calcula precio sumando precio ingrediente * cantidad
                const calculatedPrice = computed(() => {
                    return costIngredientes.value + costGastos.value;
                });

                const saveProductos = () => {
                    try { localStorage.setItem(PRODUCTOS_KEY, JSON.stringify(store.productos)); } catch(e){ console.error(e); }
                };
                const saveRecetasStorage = () => {
                    try { localStorage.setItem(RECETAS_KEY, JSON.stringify(store.recetas)); } catch(e){ console.error(e); }
                };

                // crear o actualizar receta
                const saveRecipe = () => {
                    if (!recipe.value.nombre.trim()) { alert('Nombre de receta requerido'); return; }
                    if (!recipe.value.ingredientes.length) { alert('Agregue al menos un ingrediente'); return; }
                    // validar ingredientes seleccionados
                    for (const ing of recipe.value.ingredientes) {
                        if (!ing.productoId || !ing.cantidad || ing.cantidad <= 0 || !ing.unidad) {
                            alert('Revise los ingredientes: producto, cantidad y unidad requeridos');
                            return;
                        }
                    }

                    const almacenObj = store.almacenes.find(a => a.id == recipe.value.almacenId);
                    const ingredientesProcessados = recipe.value.ingredientes.map(ing => {
                        const p = store.productos.find(x => x.id == ing.productoId);
                        return { productoId: ing.productoId, nombre: p ? p.nombre : '', cantidad: Number(ing.cantidad), unidad: ing.unidad };
                    });

                    const gastosProcessados = recipe.value.gastos.map(g => ({
                        concepto: g.concepto.trim(),
                        costo: Number(g.costo) || 0
                    }));

                    if (editingId.value) {
                        // Actualizar receta existente
                        const idx = store.recetas.findIndex(r => r.id === editingId.value);
                        if (idx !== -1) {
                            store.recetas[idx] = {
                                ...store.recetas[idx],
                                nombre: recipe.value.nombre.trim(),
                                almacenId: recipe.value.almacenId,
                                almacen: almacenObj ? almacenObj.nombre : '',
                                unidad: recipe.value.unidad,
                                ingredientes: ingredientesProcessados,
                                gastos: gastosProcessados,
                                precio: Number(calculatedPrice.value) || 0
                            };
                            // Actualizar también el producto compuesto asociado
                            const prodIdx = store.productos.findIndex(p => p.nombre === store.recetas[idx].nombre && p.tipo === 'compuesto');
                            if (prodIdx !== -1) {
                                store.productos[prodIdx].precio = Number(calculatedPrice.value) || 0;
                                store.productos[prodIdx].ingredientes = ingredientesProcessados;
                            }
                        }
                    } else {
                        // Crear nueva receta
                        const nextRecId = store.recetas.length ? Math.max(...store.recetas.map(r => r.id)) + 1 : 1;
                        const recetaObj = {
                            id: nextRecId,
                            nombre: recipe.value.nombre.trim(),
                            almacenId: recipe.value.almacenId,
                            almacen: almacenObj ? almacenObj.nombre : '',
                            unidad: recipe.value.unidad,
                            ingredientes: ingredientesProcessados,
                            gastos: gastosProcessados,
                            precio: Number(calculatedPrice.value) || 0,
                            fecha: new Date().toLocaleString()
                        };

                        // guardar receta
                        store.recetas.push(recetaObj);

                        // crear producto compuesto resultante de la receta
                        const nextProdId = store.productos.length ? Math.max(...store.productos.map(p => p.id)) + 1 : 1;
                        const productoCompuesto = {
                            id: nextProdId,
                            nombre: recetaObj.nombre,
                            tipo: 'compuesto',
                            almacenId: recetaObj.almacenId,
                            almacen: recetaObj.almacen,
                            unidad: recetaObj.unidad,
                            stock: 0,
                            precio: recetaObj.precio,
                            ingredientes: recetaObj.ingredientes
                        };
                        store.productos.push(productoCompuesto);
                    }

                    saveRecetasStorage();
                    saveProductos();
                    closeModal();
                };

                const deleteRecipe = (id) => {
                    if (!confirm('¿Eliminar receta? Esto no eliminará el producto generado.')) return;
                    const receta = store.recetas.find(r => r.id === id);
                    if (receta) {
                        // También eliminar el producto compuesto asociado
                        store.productos = store.productos.filter(p => !(p.nombre === receta.nombre && p.tipo === 'compuesto'));
                    }
                    store.recetas = store.recetas.filter(r => r.id !== id);
                    saveRecetasStorage();
                    saveProductos();
                };

                return { store, showModal, editingId, recipe, openModal, closeModal, editRecipe, addIngredient, removeIngredient, addGasto, removeGasto, costIngredientes, costGastos, calculatedPrice, saveRecipe, deleteRecipe, saveRecetasStorage };
            }
        };

        // Ventas view
        const Ventas = {
            name: 'VentasView',
            template: `
                <div>
                    <h1 class="title">Ventas</h1>
                    <p class="subtitle">Historial de ventas</p>

                    <div class="box" v-if="store.ventas.length">
                        <ul>
                            <li v-for="v in store.ventas" :key="v.id">
                                <strong>{{ v.id }}</strong> — {{ v.total }} — {{ v.fecha }}
                            </li>
                        </ul>
                    </div>
                    <div class="notification is-info" v-else>No hay ventas registradas.</div>
                </div>
            `,
            setup() { return { store }; }
        };

        // Rutas
        const routes = [
            { path: '/', component: Home },
            { path: '/almacenes', component: Almacenes },
            { path: '/productos', component: Productos },
            { path: '/ventas', component: Ventas },
            // nueva ruta recetas
            { path: '/recetas', component: Recetas },
            { path: '/:pathMatch(.*)*', redirect: '/' }
        ];

        const router = createRouter({
            history: createWebHashHistory(),
            routes
        });

        // cerrar menú móvil al navegar (mejora UX app-like)
        router.afterEach(() => { store.mobileMenu = false; });

        // Crear app raíz y proveer el store a componentes
        const App = {
            setup() {
                provide('store', store);
                // escuchar cambios de conexión y exponer en store
                window.addEventListener('online', () => { store.offline = false; });
                window.addEventListener('offline', () => { store.offline = true; });
                return { store };
            }
        };

        createApp(App).use(router).mount('#app');
    })();
    </script>
</body>
</html>