<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi PWA Vue CDN — con Router</title>

    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Mi Vue PWA">

    <!-- Bulma CSS (se mantiene) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <!-- Font Awesome: iconos representativos (CDN) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <div id="app">
        <nav class="navbar is-primary" role="navigation" aria-label="main navigation">
            <div class="navbar-brand">
                <a class="navbar-item" href="#" @click.prevent>
                    <span class="icon" aria-hidden="true"><i class="fa-solid fa-utensils"></i></span>
                    <strong style="margin-left:8px">Kitchen Boost</strong>
                </a>

                <!-- burger usa store.mobileMenu -->
                <a role="button"
                   class="navbar-burger"
                   :class="{ 'is-active': store.mobileMenu }"
                   @click="store.mobileMenu = !store.mobileMenu"
                   aria-label="menu"
                   aria-expanded="false">
                    <span aria-hidden="true"></span>
                    <span aria-hidden="true"></span>
                    <span aria-hidden="true"></span>
                </a>
            </div>

            <!-- navbar-menu también atado al store -->
            <div class="navbar-menu" :class="{ 'is-active': store.mobileMenu }">
                <div class="navbar-start">
                    <router-link class="navbar-item" to="/" @click.native="store.mobileMenu = false">
                        <span class="icon"><i class="fa-solid fa-house"></i></span>
                        <span style="margin-left:8px">Inicio</span>
                    </router-link>
                    <router-link class="navbar-item" to="/almacenes" @click.native="store.mobileMenu = false">
                        <span class="icon"><i class="fa-solid fa-warehouse"></i></span>
                        <span style="margin-left:8px">Almacenes</span>
                    </router-link>
                    <router-link class="navbar-item" to="/productos" @click.native="store.mobileMenu = false">
                        <span class="icon"><i class="fa-solid fa-box-open"></i></span>
                        <span style="margin-left:8px">Productos</span>
                    </router-link>
                    <router-link class="navbar-item" to="/ventas" @click.native="store.mobileMenu = false">
                        <span class="icon"><i class="fa-solid fa-receipt"></i></span>
                        <span style="margin-left:8px">Ventas</span>
                    </router-link>
                </div>
            </div>
        </nav>

        <section class="section">
            <div class="container">
                <router-view />
            </div>
        </section>
    </div>

    <!-- Vue + Vue Router (CDN) -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/vue-router@4/dist/vue-router.global.js"></script>

    <script>
    (function () {
        const { createApp, ref, reactive, provide, computed } = Vue;
        const { createRouter, createWebHashHistory } = VueRouter;

        // Simple global "store" para compartir datos entre rutas
        const store = reactive({
            offline: !navigator.onLine,
            mobileMenu: false,
            // ejemplo de datos compartidos: recetas/productos/almacenes
            almacenes: [
                { id: 1, nombre: 'Principal', ubicacion: 'Centro' }
            ],
            productos: [
                { id: 1, nombre: 'Tomate', tipo: 'basico', almacenId: 1, almacen: 'Principal', unidad: 'Kilogramos', stock: 50, precio: 0, ingredientes: [] }
            ],
            ventas: []
        });

        // Home (counter + estado offline)
        const Home = {
            name: 'HomeView',
            template: `
                <div>
                    <h1 class="title">Inicio</h1>
                    <p class="subtitle">Contador simple y estado offline</p>

                    <div class="box">
                        <p class="has-text-weight-semibold">Contador: {{ contador }}</p>
                        <button class="button is-primary" @click="incrementar">Incrementar</button>
                        <p v-if="store.offline" class="notification is-warning mt-3">¡Estás sin conexión!</p>
                    </div>
                </div>
            `,
            setup() {
                const contador = ref(0);
                const incrementar = () => contador.value++;
                return { contador, incrementar, store };
            }
        };

        // Almacenes view
        const Almacenes = {
            name: 'AlmacenesView',
            template: `
                <div>
                    <h1 class="title">Almacenes</h1>
                    <p class="subtitle">Gestiona tus almacenes</p>

                    <div class="box">
                        <div class="table-container">
                            <table class="table is-fullwidth is-striped is-hoverable">
                                <thead>
                                    <tr><th>Nombre</th><th>Ubicación</th></tr>
                                </thead>
                                <tbody>
                                    <tr v-for="a in store.almacenes" :key="a.id">
                                        <td><strong>{{ a.nombre }}</strong></td>
                                        <td>{{ a.ubicacion }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `,
            setup() { return { store }; }
        };

        // Productos view (modificado: modal separada para formulario)
        const Productos = {
            name: 'ProductosView',
            template: `
                <div>
                    <h1 class="title">Productos</h1>
                    <p class="subtitle">Listado de productos — crear / eliminar</p>

                    <div class="mb-4">
                        <button class="button is-primary" @click="openModal">
                            <span class="icon"><i class="fa-solid fa-plus"></i></span>
                            <span>Nuevo producto</span>
                        </button>
                    </div>

                    <!-- Modal para agregar producto -->
                    <div class="modal" :class="{ 'is-active': showModal }">
                        <div class="modal-background" @click="closeModal"></div>
                        <div class="modal-card">
                            <header class="modal-card-head">
                                <p class="modal-card-title">
                                    <span class="icon"><i class="fa-solid fa-plus"></i></span>
                                    <span>Agregar nuevo producto</span>
                                </p>
                                <button class="delete" @click="closeModal"></button>
                            </header>
                            <section class="modal-card-body">
                                <form @submit.prevent="addProduct">
                                    <div class="field">
                                        <label class="label">Nombre</label>
                                        <div class="control">
                                            <input class="input" v-model="newProduct.nombre" placeholder="Ej. Tomate" required>
                                        </div>
                                    </div>

                                    <div class="columns is-mobile">
                                        <div class="column is-6">
                                            <div class="field">
                                                <label class="label">Tipo</label>
                                                <div class="control">
                                                    <div class="select is-fullwidth">
                                                        <select v-model="newProduct.tipo">
                                                            <option value="basico">Básico</option>
                                                            <option value="compuesto">Compuesto</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="column is-6">
                                            <div class="field">
                                                <label class="label">Almacén</label>
                                                <div class="control">
                                                    <div class="select is-fullwidth">
                                                        <select v-model.number="newProduct.almacenId" required>
                                                            <option v-for="a in store.almacenes" :key="a.id" :value="a.id">{{ a.nombre }}</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="columns is-mobile">
                                        <div class="column is-6">
                                            <div class="field">
                                                <label class="label">Unidad</label>
                                                <div class="control">
                                                    <div class="select is-fullwidth">
                                                        <select v-model="newProduct.unidad" required>
                                                            <option value="Unidad">Unidad</option>
                                                            <option value="Gramos">Gramos</option>
                                                            <option value="Kilogramos">Kilogramos</option>
                                                            <option value="Litros">Litros</option>
                                                            <option value="Mililitros">Mililitros</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="column is-6">
                                            <div class="field">
                                                <label class="label">Stock</label>
                                                <div class="control">
                                                    <input type="number" class="input" v-model.number="newProduct.stock" min="0" required>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="field">
                                        <label class="label">Precio</label>
                                        <div class="control">
                                            <input type="number" class="input" v-model.number="newProduct.precio" step="0.01" min="0">
                                        </div>
                                    </div>

                                    <div class="field is-grouped">
                                        <div class="control">
                                            <button type="submit" class="button is-primary">
                                                <span class="icon"><i class="fa-solid fa-check"></i></span>
                                                <span>Guardar</span>
                                            </button>
                                        </div>
                                        <div class="control">
                                            <button type="button" @click="closeModal" class="button is-light">Cancelar</button>
                                        </div>
                                    </div>
                                </form>
                            </section>
                        </div>
                    </div>

                    <!-- Vista de tarjetas en móviles (is-hidden-tablet) -->
                    <div class="is-hidden-tablet">
                        <div class="columns is-multiline is-mobile">
                            <div class="column is-12" v-for="p in store.productos" :key="p.id">
                                <div class="card">
                                    <div class="card-content">
                                        <div class="media">
                                            <div class="media-content">
                                                <p class="title is-5">{{ p.nombre }}</p>
                                                <p class="subtitle is-6">{{ p.almacen }}</p>
                                            </div>
                                        </div>
                                        <div class="content">
                                            <div class="level is-mobile mb-2">
                                                <div class="level-left">
                                                    <div class="level-item">
                                                        <div>
                                                            <span class="tag is-light" :class="p.tipo === 'basico' ? 'is-info' : 'is-warning'">
                                                                {{ p.tipo }}
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="level-right">
                                                    <div class="level-item">
                                                        <strong class="has-text-success">\${{ p.precio.toFixed(2) }}</strong>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="level is-mobile mb-2">
                                                <div class="level-left">
                                                    <div class="level-item">
                                                        <small class="has-text-grey">{{ p.unidad }}</small>
                                                    </div>
                                                </div>
                                                <div class="level-right">
                                                    <div class="level-item">
                                                        <span class="tag" :class="p.stock > 20 ? 'is-success' : p.stock > 0 ? 'is-warning' : 'is-danger'">
                                                            Stock: {{ p.stock }}
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <footer class="card-footer">
                                        <a href="#" class="card-footer-item has-text-danger" @click.prevent="deleteProduct(p.id)">
                                            <span class="icon"><i class="fa-solid fa-trash"></i></span>
                                            <span>Eliminar</span>
                                        </a>
                                    </footer>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Vista de tabla en tablets y escritorio (is-hidden-mobile) -->
                    <div class="is-hidden-mobile">
                        <div class="box">
                            <div class="table-container">
                                <table class="table is-fullwidth is-striped">
                                    <thead>
                                        <tr>
                                            <th>Nombre</th>
                                            <th>Tipo</th>
                                            <th>Almacén</th>
                                            <th>Unidad</th>
                                            <th>Stock</th>
                                            <th>Precio</th>
                                            <th style="width:120px">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="p in store.productos" :key="p.id">
                                            <td>{{ p.nombre }}</td>
                                            <td>
                                                <span class="tag" :class="p.tipo === 'basico' ? 'is-info' : 'is-warning'">
                                                    {{ p.tipo }}
                                                </span>
                                            </td>
                                            <td>{{ p.almacen || (getAlmacenName(p.almacenId) || '-') }}</td>
                                            <td>{{ p.unidad || 'Unidad' }}</td>
                                            <td>
                                                <span class="tag" :class="p.stock > 20 ? 'is-success' : p.stock > 0 ? 'is-warning' : 'is-danger'">
                                                    {{ p.stock }}
                                                </span>
                                            </td>
                                            <td>\${{ p.precio.toFixed(2) }}</td>
                                            <td>
                                                <button class="button is-small is-danger is-outlined" @click="deleteProduct(p.id)">
                                                    <span class="icon"><i class="fa-solid fa-trash"></i></span>
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `,
            setup() {
                const showModal = ref(false);
                
                // Template vacío para reiniciar el formulario
                const getEmptyProduct = () => ({
                    nombre: '',
                    tipo: 'basico',
                    almacenId: (store.almacenes[0] && store.almacenes[0].id) || null,
                    almacen: '',
                    unidad: 'Unidad',
                    stock: 0,
                    precio: 0,
                    ingredientes: []
                });
                
                const newProduct = ref(getEmptyProduct());

                const STORAGE_KEY = 'kb_productos';

                const saveProductos = () => {
                    try {
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(store.productos));
                    } catch (e) { console.error('Error guardando productos:', e); }
                };

                // Abre la modal y reinicia el formulario
                const openModal = () => {
                    newProduct.value = getEmptyProduct();
                    showModal.value = true;
                };

                // Cierra la modal y vacía el formulario
                const closeModal = () => {
                    showModal.value = false;
                    newProduct.value = getEmptyProduct();
                };

                // Añade un nuevo producto al store y persiste en localStorage
                const addProduct = () => {
                    if (!newProduct.value.nombre.trim()) {
                        alert('Nombre requerido');
                        return;
                    }
                    if (!newProduct.value.unidad) {
                        alert('Seleccione la unidad de medida');
                        return;
                    }
                    // calcular id único
                    const nextId = store.productos.length ? Math.max(...store.productos.map(p => p.id)) + 1 : 1;
                    const almacenObj = store.almacenes.find(a => a.id == newProduct.value.almacenId);
                    const producto = {
                        id: nextId,
                        nombre: newProduct.value.nombre.trim(),
                        tipo: newProduct.value.tipo,
                        almacenId: newProduct.value.almacenId,
                        almacen: almacenObj ? almacenObj.nombre : '',
                        unidad: newProduct.value.unidad,
                        precio: Number(newProduct.value.precio) || 0,
                        stock: Number(newProduct.value.stock) || 0,
                        ingredientes: newProduct.value.ingredientes || []
                    };
                    store.productos.push(producto);
                    saveProductos();
                    closeModal();
                };

                const deleteProduct = (id) => {
                    if (!confirm('¿Eliminar producto?')) return;
                    store.productos = store.productos.filter(p => p.id !== id);
                    saveProductos();
                };

                const getAlmacenName = (id) => {
                    const a = store.almacenes.find(x => x.id == id);
                    return a ? a.nombre : '';
                };

                return { store, showModal, newProduct, openModal, closeModal, addProduct, deleteProduct, getAlmacenName };
            }
        };

        // Ventas view
        const Ventas = {
            name: 'VentasView',
            template: `
                <div>
                    <h1 class="title">Ventas</h1>
                    <p class="subtitle">Historial de ventas</p>

                    <div class="box" v-if="store.ventas.length">
                        <ul>
                            <li v-for="v in store.ventas" :key="v.id">
                                <strong>{{ v.id }}</strong> — {{ v.total }} — {{ v.fecha }}
                            </li>
                        </ul>
                    </div>
                    <div class="notification is-info" v-else>No hay ventas registradas.</div>
                </div>
            `,
            setup() { return { store }; }
        };

        // Rutas
        const routes = [
            { path: '/', component: Home },
            { path: '/almacenes', component: Almacenes },
            { path: '/productos', component: Productos },
            { path: '/ventas', component: Ventas },
            { path: '/:pathMatch(.*)*', redirect: '/' }
        ];

        const router = createRouter({
            history: createWebHashHistory(),
            routes
        });

        // cerrar menú móvil al navegar (mejora UX app-like)
        router.afterEach(() => { store.mobileMenu = false; });

        // Crear app raíz y proveer el store a componentes
        const App = {
            setup() {
                provide('store', store);
                // escuchar cambios de conexión y exponer en store
                window.addEventListener('online', () => { store.offline = false; });
                window.addEventListener('offline', () => { store.offline = true; });
                return { store };
            }
        };

        createApp(App).use(router).mount('#app');
    })();
    </script>
</body>
</html>